;;; -*- Lisp -*-
#+(or f1 f2)
    (error "This test cannot run if :f1 or :f2 are on *features*")
(load "script-support")
(load-asdf)
(in-package :asdf)
(cl-user::quit-on-error
 (let ((fasl1 (asdf:compile-file-pathname* (truename "file1.lisp")))
       (fasl2 (asdf:compile-file-pathname* (truename "file2.lisp"))))
     (asdf:run-shell-command "rm -f ~A ~A"
                             (namestring fasl1)
                             (namestring fasl2))
     (setf asdf:*central-registry* '(*default-pathname-defaults*))
     (handler-case
         (asdf:oos 'asdf:load-op 'test3)
       (asdf:missing-dependency (c)
         (format t "first test failed as expected: - ~%~A~%" c))
       (:no-error (c)
         (declare (ignore c))
         (error "should have failed, oops")))
     (pushnew :f1 *features*)
     (asdf:oos 'asdf:load-op 'test3)
     (assert (probe-file fasl1))
     (assert (not (probe-file fasl2)))
     (run-shell-command "rm -f ~A" (namestring fasl1))
     (setf *features* (cons :f2 (cdr *features*)))
     (asdf:oos 'asdf:load-op 'test3)
     (assert (probe-file fasl2))
     (assert (not (probe-file fasl1)))))
